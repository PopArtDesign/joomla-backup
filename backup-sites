#!/usr/bin/env bash

BACKUP_PATH=${BACKUP_PATH=$HOME/sites-backups}
BACKUP_COMMAND=$(dirname $(readlink -f $0))/joomla-backup

current_time=$(date +%F_%R:%S)
backup_dir=$BACKUP_PATH/$current_time

mkdir $backup_dir
if [[ $? -gt 0 ]]; then
    echo "Can't create directory for backups ($backup_dir)"
    exit 1
fi

for site in /etc/apache2/sites-available/*; do
    site_path=$(sed -ne 's/^[[:space:]]*DocumentRoot[[:space:]]\+\([^[:space:]]*\)/\1/p' $site) 
    site_name=$(sed -ne 's/^[[:space:]]*ServerName[[:space:]]\+\([^[:space:]]*\)/\1/p' $site) 

    if [[ -z $site_name ]]; then
        echo "Backuping: $site"
    else
        echo "Backuping: $(tput setaf 2)$site_name$(tput sgr 0) ($site)"
    fi
    echo "Document root: $site_path"

    backup_file=$backup_dir/$site_name\_$current_time.zip
    $BACKUP_COMMAND $site_path $backup_file 1>/dev/null

    if [[ $? -eq 0 ]]; then
        echo "Backup was saved to $backup_file"
    fi

    echo 
done
